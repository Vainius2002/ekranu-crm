{% extends "base.html" %}

{% block content %}
<!-- Header Section -->
<div class="pb-5 border-b border-gray-200 mb-8">
    <div class="flex justify-between items-start">
        <div class="flex items-center">
            <div class="h-12 w-12 rounded-full bg-yellow-100 flex items-center justify-center mr-4">
                <i class="fas fa-play-circle text-yellow-600 text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Media Planas</h1>
                <p class="mt-1 text-sm text-gray-500">
                    {{ plan.name }} • {{ plan.start_date.strftime('%Y-%m-%d') }} - {{ plan.end_date.strftime('%Y-%m-%d') }}
                </p>
            </div>
        </div>
        <div class="flex space-x-3">
            <button onclick="showAddScreenModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-plus -ml-1 mr-2"></i>
                Pridėti Ekraną
            </button>
            <button onclick="calculateTotals()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-calculator -ml-1 mr-2"></i>
                Perskaičiuoti
            </button>
            {% if plan.screen_bookings|length == 1 %}
            <a href="{{ url_for('screen_detail', id=plan.screen_bookings[0].screen.id) }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                <i class="fas fa-tv -ml-1 mr-2"></i>
                Peržiūrėti Ekraną
            </a>
            {% else %}
            <a href="{{ url_for('dooh_plan_screens', id=plan.id) }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                <i class="fas fa-tv -ml-1 mr-2"></i>
                Valdyti Ekranus
            </a>
            {% endif %}
            <a href="{{ url_for('dooh_plan_detail', id=plan.id) }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-arrow-left -ml-1 mr-2"></i>
                Grįžti
            </a>
        </div>
    </div>
</div>

<!-- Media Plan Information Header -->
<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
    <div class="px-4 py-5 sm:px-6">
        <div class="text-center">
            <div class="text-4xl font-bold text-yellow-600 mb-2">{{ plan.screen_bookings|length }}</div>
            <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Ekranų skaičius</p>
        </div>
    </div>
</div>

{% if not plan.screen_bookings %}
<div class="rounded-md bg-yellow-50 p-4">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Nėra pasirinktų ekranų!</h3>
            <div class="mt-2 text-sm text-yellow-700">
                <p><a href="{{ url_for('dooh_plan_screens', id=plan.id) }}" class="font-medium underline hover:text-yellow-600">Pirmiausia pasirinkite ekranus</a>.</p>
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Media Plan Calendar (TV-Planner Style) -->
<div class="mb-6">
    <h3 class="font-medium text-slate-700 mb-3">Media plano paskirstymas pagal dienas</h3>
    <div id="mediaPlanCalendar" class="bg-white border border-slate-200 rounded-lg overflow-x-auto">
        <!-- Calendar table will be generated here -->
        <div class="p-4 text-sm text-slate-500">Kalendorius kraunasi...</div>
    </div>
</div>


<!-- New Week Calendar (Initially Hidden) -->
<div class="card mb-4" id="newWeekCalendarCard" style="display: none;">
    <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i>Sukurti Naują Savaitę</h5>
            <button class="btn btn-light btn-sm" onclick="cancelNewWeek()">
                <i class="fas fa-times"></i> Atšaukti
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <!-- New Week Calendar Grid -->
                <div class="calendar-grid">
                    <div class="calendar-header">
                        <div class="calendar-month" id="newWeekCurrentMonth">
                            {{ plan.start_date.strftime('%Y %B') }}
                        </div>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="weekday">Pr</div>
                        <div class="weekday">An</div>
                        <div class="weekday">Tr</div>
                        <div class="weekday">Kt</div>
                        <div class="weekday">Pn</div>
                        <div class="weekday">Št</div>
                        <div class="weekday">Sk</div>
                    </div>
                    <div class="calendar-dates" id="newWeekCalendarDates">
                        <!-- Calendar dates will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="new-week-info">
                    <div id="newWeekRange" class="text-success fw-bold fs-5 mb-3">
                        Pasirinkite savaitę...
                    </div>
                    <div class="mb-3">
                        <label for="newWeekName" class="form-label">Naujos savaitės pavadinimas:</label>
                        <input type="text" id="newWeekName" class="form-control mb-2" placeholder="pvz. Savaitė 2">
                        <button class="btn btn-success w-100" onclick="confirmCreateNewWeek()" disabled id="confirmNewWeekBtn">
                            <i class="fas fa-save me-2"></i>Sukurti savaitę
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            Nauja savaitė bus sukurta pagal pasirinktą datų intervalą
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Screen Modal (Initially Hidden) -->
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden" id="addScreenModal">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">
        <div class="inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-tv text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            Pridėti Ekraną
                        </h3>
                        <div class="mt-4">
                            <label for="screenSelect" class="block text-sm font-medium text-gray-700">Pasirinkite ekraną:</label>
                            <select id="screenSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Pasirinkite ekraną...</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="addScreenToMediaPlan()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-plus mr-2"></i>
                    Pridėti
                </button>
                <button type="button" onclick="hideAddScreenModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Atšaukti
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Media Plan Summary (Below Calendar) -->
<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
            <i class="fas fa-chart-bar mr-2 text-blue-600"></i>Media Plano Suvestinė
        </h3>
    </div>
    <div class="px-6 py-4">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-3">
            <div class="bg-blue-50 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-play-circle text-blue-600 text-2xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Viso transliacijų</dt>
                                <dd class="text-lg font-medium text-gray-900" id="totalSlots">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-green-50 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-euro-sign text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Bendra kaina</dt>
                                <dd class="text-lg font-medium text-gray-900" id="totalCost">0.00€</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-percentage text-yellow-600 text-2xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Vidutinis CPT</dt>
                                <dd class="text-lg font-medium text-gray-900" id="avgCPT">0.00€</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Instructions for Users -->
<div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-blue-400"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">
                Kaip naudoti media planą
            </h3>
            <div class="mt-2 text-sm text-blue-700">
                <ul class="list-disc pl-5 space-y-1">
                    <li>Įveskite transliacijų skaičių kiekvienai dienai ir ekranui kalendoriuje</li>
                    <li>Skaičiavimai atsinaujins automatiškai kaskart keičiant reikšmes</li>
                    <li>Naudokite "Pridėti Ekraną" mygtuką, kad pridėtumėte daugiau ekranų į planą</li>
                    <li>Bendroji suma ir statistikos pateikiamos aukščiau esančioje suvestinėje</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Screen Planning Forms (Below Calendar) -->
{% for booking in plan.screen_bookings %}
<!-- Container for all weeks of this screen -->
<div class="mb-8">
    <!-- Screen Header -->
    <div class="bg-gray-800 text-white px-4 py-3 rounded-t-lg">
        <div class="flex items-center">
            <div class="h-8 w-8 rounded-full bg-yellow-400 flex items-center justify-center mr-3">
                <i class="fas fa-tv text-gray-800 text-sm"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold">{{ booking.screen.name }}</h3>
                <p class="text-sm text-gray-300">{{ booking.screen.provider.name }} • {{ booking.screen.city }}</p>
            </div>
        </div>
    </div>
    
    <!-- Horizontal scrollable container for weeks -->
    <div class="overflow-x-auto bg-gray-100 p-4 rounded-b-lg">
        <div class="flex space-x-4" style="min-width: max-content;">
            {% for week_num in range(1, num_weeks + 1) %}
            <div class="bg-white shadow-sm rounded-lg screen-planning-card flex-shrink-0">
                <!-- Week Header -->
                <div class="px-3 py-2 bg-gray-50 border-b border-gray-200">
                    <div class="flex flex-col space-y-2">
                        <!-- Week Title and Stats -->
                        <div class="flex justify-between items-center">
                            <h4 class="text-sm font-semibold text-gray-900">Savaitė {{ week_num }}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                    CPT: <span class="cpt-value font-semibold" data-booking="{{ booking.id }}_w{{ week_num }}">0.00</span>€
                                </span>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                    Viso: <span class="total-price font-semibold" data-booking="{{ booking.id }}_w{{ week_num }}">0.00</span>€
                                </span>
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div class="flex justify-between items-center">
                            <div class="flex space-x-1">
                                <button class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700" onclick="fillAllDays('{{ booking.id }}_w{{ week_num }}', 30)">
                                    30
                                </button>
                                <button class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700" onclick="fillAllDays('{{ booking.id }}_w{{ week_num }}', 60)">
                                    60
                                </button>
                                <button class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" onclick="clearAllDays('{{ booking.id }}_w{{ week_num }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <button class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="calculatePrices('{{ booking.id }}_w{{ week_num }}')">
                                <i class="fas fa-calculator mr-1"></i>Skaičiuoti
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Compact Table - No internal scroll -->
                <div>
                    <table class="w-full">
                        <thead class="bg-indigo-600">
                            <tr>
                                <th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 60px;">Laikas</th>
                                <th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 50px;">Kont.</th>
                                <th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 50px;">€</th>
                                {% set week_data = week_days[week_num - 1] %}
                                {% if week_data.mon %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">Pr</th>{% endif %}
                                {% if week_data.tue %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">An</th>{% endif %}
                                {% if week_data.wed %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">Tr</th>{% endif %}
                                {% if week_data.thu %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">Kt</th>{% endif %}
                                {% if week_data.fri %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">Pn</th>{% endif %}
                                {% if week_data.sat %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">Št</th>{% endif %}
                                {% if week_data.sun %}<th class="px-2 py-1 text-center text-white text-xs font-medium" style="width: 100px;">Sk</th>{% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                            {% for hour in range(6, 24) %}
                            {% set pricing = booking.screen.pricing_hours | selectattr('hour', 'equalto', hour) | first %}
                            <tr class="time-row-{{ hour }}" style="height: 36px;">
                                <td class="text-center bg-gray-50 px-1 py-1 text-xs">
                                    <span class="font-medium">{{ "%02d"|format(hour) }}:00</span>
                                </td>
                                <!-- Contacts column -->
                                <td class="text-center px-1 py-1 bg-blue-50 text-xs">
                                    {% if pricing %}
                                        {% set day_contacts = [pricing.contacts_mon, pricing.contacts_tue, pricing.contacts_wed, pricing.contacts_thu, pricing.contacts_fri, pricing.contacts_sat, pricing.contacts_sun] %}
                                        {% set valid_contacts = day_contacts | reject("none") | list %}
                                        {% if valid_contacts %}
                                            <span class="text-xs text-blue-700">{{ "%.1f"|format(valid_contacts | sum / (valid_contacts | length)) }}</span>
                                        {% else %}
                                            <span class="text-gray-400">-</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-xs text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <!-- Price column -->
                                <td class="text-center px-1 py-1 bg-green-50 text-xs">
                                    {% if pricing and pricing.price %}
                                        <span class="text-xs text-green-700" data-price="{{ pricing.price }}">{{ "%.0f"|format(pricing.price) }}</span>
                                    {% else %}
                                        <span class="text-xs text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <!-- Pirmadienis -->
                                {% if week_data.mon %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                                onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'mon', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                               data-booking="{{ booking.id }}_w{{ week_num }}"
                                               data-hour="{{ hour }}"
                                               data-day="mon"
                                               data-contacts="{{ pricing.contacts_mon if pricing else 0 }}"
                                               value="0" min="0" max="60" step="30"
                                               onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                                onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'mon', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_mon">-</div>
                                </td>
                                {% endif %}
                    <!-- Antradienis -->
                    {% if week_data.tue %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'tue', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                   data-booking="{{ booking.id }}_w{{ week_num }}"
                                   data-hour="{{ hour }}"
                                   data-day="tue"
                                   data-contacts="{{ pricing.contacts_tue if pricing else 0 }}"
                                   value="0" min="0" max="60" step="30"
                                   onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'tue', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_tue">-</div>
                                </td>
                    {% endif %}
                    <!-- Trečiadienis -->
                    {% if week_data.wed %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'wed', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                   data-booking="{{ booking.id }}_w{{ week_num }}"
                                   data-hour="{{ hour }}"
                                   data-day="wed"
                                   data-contacts="{{ pricing.contacts_wed if pricing else 0 }}"
                                   value="0" min="0" max="60" step="30"
                                   onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'wed', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_wed">-</div>
                                </td>
                    {% endif %}
                    <!-- Ketvirtadienis -->
                    {% if week_data.thu %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'thu', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                   data-booking="{{ booking.id }}_w{{ week_num }}"
                                   data-hour="{{ hour }}"
                                   data-day="thu"
                                   data-contacts="{{ pricing.contacts_thu if pricing else 0 }}"
                                   value="0" min="0" max="60" step="30"
                                   onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'thu', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_thu">-</div>
                                </td>
                    {% endif %}
                    <!-- Penktadienis -->
                    {% if week_data.fri %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'fri', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                   data-booking="{{ booking.id }}_w{{ week_num }}"
                                   data-hour="{{ hour }}"
                                   data-day="fri"
                                   data-contacts="{{ pricing.contacts_fri if pricing else 0 }}"
                                   value="0" min="0" max="60" step="30"
                                   onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'fri', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_fri">-</div>
                                </td>
                    {% endif %}
                    <!-- Šeštadienis -->
                    {% if week_data.sat %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'sat', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                   data-booking="{{ booking.id }}_w{{ week_num }}"
                                   data-hour="{{ hour }}"
                                   data-day="sat"
                                   data-contacts="{{ pricing.contacts_sat if pricing else 0 }}"
                                   value="0" min="0" max="60" step="30"
                                   onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'sat', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_sat">-</div>
                                </td>
                    {% endif %}
                    <!-- Sekmadienis -->
                    {% if week_data.sun %}
                                <td class="text-center px-1 py-1">
                                    <div class="flex items-center justify-center">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-l"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'sun', -30)">-</button>
                                        <input type="number" class="w-10 px-1 py-0.5 text-xs border-t border-b border-gray-300 text-center weekday-input" 
                                   data-booking="{{ booking.id }}_w{{ week_num }}"
                                   data-hour="{{ hour }}"
                                   data-day="sun"
                                   data-contacts="{{ pricing.contacts_sun if pricing else 0 }}"
                                   value="0" min="0" max="60" step="30"
                                   onchange="calculatePrices('{{ booking.id }}_w{{ week_num }}')"
                                               style="width: 40px;">
                                        <button type="button" class="px-1.5 py-0.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-r"
                                    onclick="adjustValue('{{ booking.id }}_w{{ week_num }}', '{{ hour }}', 'sun', 30)">+</button>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1 hour-price" id="price_{{ booking.id }}_w{{ week_num }}_{{ hour }}_sun">-</div>
                                </td>
                    {% endif %}
                </tr>
                {% endfor %}
                
                            <!-- Grand total row -->
                            <tr class="bg-green-600 text-white">
                                <td class="text-center px-2 py-1 text-xs">
                                    <strong>VISO</strong>
                                </td>
                                <td class="text-center px-2 py-1 text-xs">
                                    <strong>-</strong>
                                </td>
                                <td class="text-center px-2 py-1 text-xs">
                                    <strong>-</strong>
                                </td>
                    {% if week_data.mon %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-mon" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                    {% if week_data.tue %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-tue" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                    {% if week_data.wed %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-wed" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                    {% if week_data.thu %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-thu" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                    {% if week_data.fri %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-fri" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                    {% if week_data.sat %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-sat" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                    {% if week_data.sun %}
                                <td class="text-center px-2 py-1 text-xs">
                                    <div class="text-xs opacity-80">KAINA</div>
                                    <strong class="day-price-sun" data-booking="{{ booking.id }}_w{{ week_num }}">0.00€</strong>
                                </td>
                    {% endif %}
                </tr>
            </tbody>
                        </table>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

{% endif %}

<script>
// Global variables
let currentWeekStart = new Date('{{ plan.start_date.strftime('%Y-%m-%d') }}');
const planStartDate = new Date('{{ plan.start_date.strftime('%Y-%m-%d') }}');
const planEndDate = new Date('{{ plan.end_date.strftime('%Y-%m-%d') }}');
const planId = {{ plan.id }};

// Mapping of booking IDs to screen IDs
const bookingToScreenMap = {
    {% for booking in plan.screen_bookings %}
    {{ booking.id }}: {{ booking.screen_id }},
    {% endfor %}
};

console.log('Booking to Screen Map:', bookingToScreenMap);

// Modal functions
function showAddScreenModal() {
    const modal = document.getElementById('addScreenModal');
    const screenSelect = document.getElementById('screenSelect');
    
    // Load available screens
    fetch('/api/screens/available/' + planId)
        .then(response => response.json())
        .then(screens => {
            screenSelect.innerHTML = '<option value="">Pasirinkite ekraną...</option>';
            screens.forEach(screen => {
                const option = document.createElement('option');
                option.value = screen.id;
                option.textContent = `${screen.name} (${screen.provider_name})`;
                screenSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading screens:', error));
    
    modal.classList.remove('hidden');
}

function hideAddScreenModal() {
    const modal = document.getElementById('addScreenModal');
    modal.classList.add('hidden');
    document.getElementById('screenSelect').value = '';
}

function addScreenToMediaPlan() {
    const screenId = document.getElementById('screenSelect').value;
    
    if (!screenId) {
        alert('Prašome pasirinkti ekraną.');
        return;
    }
    
    // Send request to add screen to media plan
    fetch(`/api/dooh-plan/${planId}/add-screen`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            screen_id: screenId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show the new screen
            location.reload();
        } else {
            alert('Klaida pridedant ekraną: ' + (data.message || 'Nežinoma klaida'));
        }
    })
    .catch(error => {
        console.error('Error adding screen:', error);
        alert('Klaida pridedant ekraną.');
    });
}

// Calendar functions
function initializeCalendar() {
    generateMediaPlanCalendar();
}

function generateMediaPlanCalendar() {
    const calendarDiv = document.querySelector('#mediaPlanCalendar');
    if (!calendarDiv || !planStartDate || !planEndDate) return;
    
    // Calculate total days in plan period
    const timeDiff = planEndDate - planStartDate;
    const totalDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) + 1;
    
    let html = '<table class="min-w-full text-sm" style="min-width: max-content;">';
    
    // Header row with dates
    html += '<thead class="bg-slate-50 text-slate-700 border-b border-slate-200">';
    html += '<tr>';
    html += '<th class="text-left font-medium px-4 py-3 bg-slate-100 border-r border-slate-300 sticky left-0 z-10" style="min-width: 200px;">Ekranas</th>';
    
    for (let day = 0; day < totalDays; day++) {
        const date = new Date(planStartDate);
        date.setDate(planStartDate.getDate() + day);
        
        const dayNames = ['Sk', 'Pr', 'An', 'Tr', 'Kt', 'Pn', 'Št'];
        const monthStr = (date.getMonth() + 1).toString().padStart(2, '0');
        const dayStr = date.getDate().toString().padStart(2, '0');
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
        
        html += `<th class="text-center font-medium px-2 py-3 border-r border-slate-300 ${isWeekend ? 'bg-slate-200 text-slate-600' : ''}" style="min-width: 80px;">`;
        html += `<div class="text-xs font-medium">${dayNames[date.getDay()]}</div>`;
        html += `<div class="text-xs">${monthStr}-${dayStr}</div>`;
        html += `</th>`;
    }
    
    html += '</tr>';
    html += '</thead>';
    
    // Body with screen rows
    html += '<tbody>';
    
    // Get screen bookings data (this should be passed from the template)
    const screenRows = document.querySelectorAll('.screen-booking-data');
    const screenBookings = [];
    
    // If we have the plan object, get the bookings
    {% if plan.screen_bookings %}
    {% for booking in plan.screen_bookings %}
    screenBookings.push({
        id: {{ booking.screen.id }},
        name: "{{ booking.screen.name }}",
        provider: "{{ booking.screen.provider.name }}"
    });
    {% endfor %}
    {% endif %}
    
    screenBookings.forEach((booking, screenIndex) => {
        html += `<tr class="border-b border-slate-200 hover:bg-slate-50">`;
        html += `<td class="px-4 py-3 text-xs font-medium bg-slate-100 border-r border-slate-300 sticky left-0 z-10" style="min-width: 200px;">`;
        html += `<div class="flex items-center">`;
        html += `<div class="h-6 w-6 rounded bg-yellow-100 flex items-center justify-center mr-2">`;
        html += `<i class="fas fa-tv text-yellow-600 text-xs"></i>`;
        html += `</div>`;
        html += `<div>`;
        html += `<div class="font-medium text-slate-900">${booking.name}</div>`;
        html += `<div class="text-xs text-slate-500">${booking.provider}</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</td>`;
        
        // Generate cells for each day
        for (let day = 0; day < totalDays; day++) {
            const date = new Date(planStartDate);
            date.setDate(planStartDate.getDate() + day);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            html += `<td class="px-2 py-3 text-center border-r border-slate-300 ${isWeekend ? 'bg-slate-50' : ''}" style="min-width: 80px;">`;
            html += `<input type="number" class="w-14 px-1 py-1 text-xs border border-slate-300 rounded text-center slots-input focus:ring-2 focus:ring-slate-500 focus:border-slate-500" `;
            html += `placeholder="0" value="" data-screen-id="${booking.id}" data-day="${day}" onchange="calculateTotals()">`;
            html += `<div class="text-xs text-slate-500 daily-cost font-medium mt-1" id="cost_${booking.id}_${day}">0.00€</div>`;
            html += `</td>`;
        }
        
        html += '</tr>';
    });
    
    // Totals row
    html += '<tr class="bg-slate-100 font-medium border-t-2 border-slate-300">';
    html += '<td class="px-4 py-3 font-bold text-center text-slate-700 sticky left-0 bg-slate-100 border-r border-slate-300">VISO DIENAI</td>';
    
    for (let day = 0; day < totalDays; day++) {
        const date = new Date(planStartDate);
        date.setDate(planStartDate.getDate() + day);
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
        
        html += `<td class="px-2 py-3 text-center font-bold text-slate-700 border-r border-slate-300 ${isWeekend ? 'bg-slate-200' : ''}" style="min-width: 80px;" id="dayTotal_${day}">0.00€</td>`;
    }
    
    html += '</tr>';
    html += '</tbody>';
    html += '</table>';
    
    calendarDiv.innerHTML = html;
    
    // Add scroll hint
    const scrollHint = document.createElement('div');
    scrollHint.className = 'text-center mt-2';
    scrollHint.innerHTML = '<p class="text-sm text-slate-500 scroll-hint"><i class="fas fa-arrows-alt-h mr-1"></i>Slinkite horizontaliai peržiūrėti visas dienas</p>';
    calendarDiv.parentNode.appendChild(scrollHint);
}

function isDateInCurrentWeek(date) {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    return date >= currentWeekStart && date <= weekEnd;
}

function selectWeekFromDate(date) {
    // Get Monday of the week containing this date
    const dayOfWeek = date.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Handle Sunday
    currentWeekStart = new Date(date);
    currentWeekStart.setDate(date.getDate() + mondayOffset);
    
    generateCalendar();
    updateSelectedWeekRange();
}

function updateSelectedWeekRange() {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    const rangeText = formatDate(currentWeekStart) + ' - ' + formatDate(weekEnd);
    document.getElementById('selectedWeekRange').textContent = rangeText;
}

function previousWeek() {
    const newWeekStart = new Date(currentWeekStart);
    newWeekStart.setDate(newWeekStart.getDate() - 7);
    
    if (newWeekStart >= planStartDate) {
        currentWeekStart = newWeekStart;
        generateCalendar();
        updateSelectedWeekRange();
    }
}

function nextWeek() {
    const newWeekStart = new Date(currentWeekStart);
    newWeekStart.setDate(newWeekStart.getDate() + 7);
    
    if (newWeekStart <= planEndDate) {
        currentWeekStart = newWeekStart;
        generateCalendar();
        updateSelectedWeekRange();
    }
}


// Screen-specific calculation function (kept for compatibility)
function calculateScreenTotals(bookingId) {
    calculatePrices(bookingId);
}

// Overall totals calculation
function calculateOverallTotals() {
    let totalSlots = 0;
    let totalCost = 0;
    
    // Sum up all weekday input values and their calculated prices
    document.querySelectorAll('.weekday-input').forEach(input => {
        const selectedValue = parseInt(input.value || 0);
        const bookingId = input.dataset.booking;
        const hour = parseInt(input.dataset.hour);
        const day = input.dataset.day;
        const contacts = parseFloat(input.dataset.contacts || 0);
        
        if (selectedValue > 0 && contacts > 0) {
            // Step 1: SUM = tukst kontaktu * (60 or 30) / 30 * 2
            const sum = contacts * selectedValue / 30 * 2;
            
            // Step 2: TUKST. kontaktu * 1 * SUM = kaina
            const kaina = contacts * 1 * sum;
            
            totalSlots += selectedValue;
            totalCost += kaina;
        }
    });
    
    // Update summary displays if they exist
    const totalSlotsElement = document.getElementById('totalSlots');
    const totalCostElement = document.getElementById('totalCost');
    const avgCPTElement = document.getElementById('avgCPT');
    
    if (totalSlotsElement) totalSlotsElement.textContent = totalSlots;
    if (totalCostElement) totalCostElement.textContent = totalCost.toFixed(2) + '€';
    if (avgCPTElement) {
        const avgCPT = totalSlots > 0 ? (totalCost / totalSlots) : 0;
        avgCPTElement.textContent = avgCPT.toFixed(2) + '€';
    }
}

// Calendar calculation function (updated)
function calculateTotals() {
    const timeDiff = planEndDate - planStartDate;
    const totalDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) + 1;
    let dailyTotals = new Array(totalDays).fill(0);
    
    // Get all screen rows
    const screenRows = document.querySelectorAll('.calendar-screen-row');
    
    screenRows.forEach(screenRow => {
        const screenId = screenRow.dataset.screenId;
        let screenTotalCost = 0;
        
        // Calculate cost for each day for this screen
        for (let day = 0; day < totalDays; day++) {
            const slotsInput = screenRow.querySelector(`input[data-screen-id="${screenId}"][data-day="${day}"]`);
            const costDisplay = screenRow.querySelector(`#cost_${screenId}_${day}`);
            
            if (slotsInput && costDisplay) {
                const slots = parseInt(slotsInput.value || 0);
                
                // Calculate cost - using base rate of €5 per slot
                const dailyCost = slots * 5.0;
                screenTotalCost += dailyCost;
                dailyTotals[day] += dailyCost;
                
                // Update daily cost display
                costDisplay.textContent = dailyCost.toFixed(2) + '€';
            }
        }
    });
    
    // Update daily totals in the totals row
    for (let day = 0; day < totalDays; day++) {
        const totalCell = document.getElementById(`dayTotal_${day}`);
        if (totalCell) {
            totalCell.textContent = dailyTotals[day].toFixed(2) + '€';
        }
    }
    
    // Also update overall summary
    calculateOverallTotals();
}

// Adjust input value by increment (30 or -30)
function adjustValue(bookingId, hour, day, increment) {
    const input = document.querySelector(`input[data-booking="${bookingId}"][data-hour="${hour}"][data-day="${day}"]`);
    if (input) {
        const currentValue = parseInt(input.value) || 0;
        const newValue = Math.max(0, Math.min(60, currentValue + increment)); // Don't allow negative values or values > 60
        input.value = newValue;
        
        // Trigger the calculation
        calculatePrices(bookingId);
        
        // After saving is complete, refresh calendar totals to reflect the changes
        setTimeout(() => {
            refreshCalendarTotals();
        }, 500); // Small delay to ensure save operation completes first
    }
}

// Fill all days with specified value (30 or 60)
function fillAllDays(bookingId, value) {
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    
    // Fill all hour/day combinations with the specified value
    for (let hour = 6; hour < 24; hour++) {
        days.forEach(day => {
            const input = document.querySelector(`input[data-booking="${bookingId}"][data-hour="${hour}"][data-day="${day}"]`);
            if (input) {
                input.value = value;
            }
        });
    }
    
    // Automatically calculate prices after filling
    calculatePrices(bookingId);
    
    // After saving is complete, refresh calendar totals to reflect the changes
    setTimeout(() => {
        refreshCalendarTotals();
    }, 500); // Small delay to ensure save operation completes first
}

// Clear all days
function clearAllDays(bookingId) {
    if (confirm('Ar tikrai norite išvalyti visus pasirinkimus?')) {
        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        
        // Clear all hour/day combinations
        for (let hour = 6; hour < 24; hour++) {
            days.forEach(day => {
                const input = document.querySelector(`input[data-booking="${bookingId}"][data-hour="${hour}"][data-day="${day}"]`);
                if (input) {
                    input.value = '0';
                }
                
                // Clear price displays
                const priceDisplay = document.getElementById(`price_${bookingId}_${hour}_${day}`);
                if (priceDisplay) {
                    priceDisplay.textContent = '-';
                }
            });
        }
        
        // Clear day totals
        days.forEach(day => {
            const dayPriceElement = document.querySelector(`.day-price-${day}[data-booking="${bookingId}"]`);
            if (dayPriceElement) {
                dayPriceElement.textContent = '0.00€';
            }
        });
        
        // Clear total price displays
        const totalPriceElement = document.querySelector(`.total-price[data-booking="${bookingId}"]`);
        if (totalPriceElement) {
            totalPriceElement.textContent = '0.00';
        }
        
        const cptElement = document.querySelector(`[data-booking="${bookingId}"].cpt-value`);
        if (cptElement) {
            cptElement.textContent = '0.00';
        }
        
        // Reset totals and save the cleared data (now includes zero values)
        calculatePrices(bookingId);
        
        // After saving is complete, refresh calendar totals to reflect the changes
        setTimeout(() => {
            refreshCalendarTotals();
        }, 1000); // Increased delay to ensure save operation completes first
    }
}

// Copy to all days function (kept for compatibility)
function copyToAllDays(bookingId) {
    // This function is replaced by fillAllDays
    fillAllDays(bookingId, 30);
}

function updateCalendarCPT(dailyTotals) {
    // Update calendar day displays
    for (let day = 0; day < 7; day++) {
        const cptElement = document.getElementById(`cpt_day_${day}`);
        if (cptElement) {
            cptElement.textContent = dailyTotals[day].toFixed(2) + '€';
        }
    }
    
    // Update total row
    const dayIds = ['mondayTotal', 'tuesdayTotal', 'wednesdayTotal', 'thursdayTotal', 'fridayTotal', 'saturdayTotal', 'sundayTotal'];
    for (let day = 0; day < 7; day++) {
        const totalElement = document.getElementById(dayIds[day]);
        if (totalElement) {
            totalElement.textContent = dailyTotals[day].toFixed(2) + '€';
        }
    }
}

function loadSelectedWeek() {
    alert('Pasirinktos savaitės duomenų įkėlimas - funkcionalumas bus pridėtas vėliau');
}

// New week creation functions
let newWeekStart = null;

function createNewWeek() {
    const newWeekCard = document.getElementById('newWeekCalendarCard');
    newWeekCard.style.display = 'block';
    
    // Initialize new week calendar
    generateNewWeekCalendar();
    
    // Scroll to new week calendar
    newWeekCard.scrollIntoView({ behavior: 'smooth' });
}

function cancelNewWeek() {
    const newWeekCard = document.getElementById('newWeekCalendarCard');
    newWeekCard.style.display = 'none';
    
    // Reset values
    newWeekStart = null;
    document.getElementById('newWeekName').value = '';
    document.getElementById('newWeekRange').textContent = 'Pasirinkite savaitę...';
    document.getElementById('confirmNewWeekBtn').disabled = true;
}

function generateNewWeekCalendar() {
    const calendarDates = document.getElementById('newWeekCalendarDates');
    const currentMonth = document.getElementById('newWeekCurrentMonth');
    
    const year = planStartDate.getFullYear();
    const month = planStartDate.getMonth();
    
    currentMonth.textContent = new Date(year, month).toLocaleDateString('lt-LT', { year: 'numeric', month: 'long' });
    
    // Clear previous dates
    calendarDates.innerHTML = '';
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay() + 1); // Start from Monday
    
    // Generate 6 weeks of calendar
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + week * 7 + day);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-date new-week-calendar-date';
            dayElement.textContent = date.getDate();
            
            // Add classes based on date status
            if (date.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            if (date < planStartDate || date > planEndDate) {
                dayElement.classList.add('disabled');
            } else {
                dayElement.addEventListener('click', () => selectNewWeekFromDate(date));
            }
            
            // Highlight selected week
            if (newWeekStart && isDateInNewWeek(date)) {
                dayElement.classList.add('selected-week');
            }
            
            calendarDates.appendChild(dayElement);
        }
    }
}

function isDateInNewWeek(date) {
    if (!newWeekStart) return false;
    const weekEnd = new Date(newWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    return date >= newWeekStart && date <= weekEnd;
}

function selectNewWeekFromDate(date) {
    // Get Monday of the week containing this date
    const dayOfWeek = date.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Handle Sunday
    newWeekStart = new Date(date);
    newWeekStart.setDate(date.getDate() + mondayOffset);
    
    generateNewWeekCalendar();
    updateNewWeekRange();
    
    // Enable confirm button
    document.getElementById('confirmNewWeekBtn').disabled = false;
}

function updateNewWeekRange() {
    if (!newWeekStart) return;
    
    const weekEnd = new Date(newWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    const rangeText = formatDate(newWeekStart) + ' - ' + formatDate(weekEnd);
    document.getElementById('newWeekRange').textContent = rangeText;
}

function confirmCreateNewWeek() {
    const weekName = document.getElementById('newWeekName').value.trim();
    if (!weekName) {
        alert('Prašome įvesti savaitės pavadinimą');
        return;
    }
    
    if (!newWeekStart) {
        alert('Prašome pasirinkti savaitę kalendoriuje');
        return;
    }
    
    // Here you would typically make an API call to create the new week
    // For now, just show a success message
    const weekEnd = new Date(newWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    const weekRange = formatDate(newWeekStart) + ' - ' + formatDate(weekEnd);
    
    alert(`Nauja savaitė "${weekName}" (${weekRange}) bus sukurta!`);
    
    // Hide the new week calendar
    cancelNewWeek();
}

// Save pricing data to database
function savePricingData(bookingId) {
    console.log(`Saving pricing data for booking: ${bookingId}`);
    const parts = bookingId.split('_w');
    if (parts.length !== 2) return;
    
    const bookingIdNum = parseInt(parts[0]);
    const screenId = bookingToScreenMap[bookingIdNum]; // Use the mapping to get correct screen ID
    const weekNumber = parseInt(parts[1]);
    
    if (!screenId) {
        console.error(`No screen ID found for booking ID ${bookingIdNum}`);
        return;
    }
    
    // Collect all pricing data for this booking
    const pricingData = [];
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    
    for (let hour = 6; hour < 24; hour++) {
        days.forEach(day => {
            const input = document.querySelector(`input[data-booking="${bookingId}"][data-hour="${hour}"][data-day="${day}"]`);
            
            if (input) {
                const selectedValue = parseInt(input.value || 0);
                const contacts = parseFloat(input.dataset.contacts || 0);
                
                // Calculate date for this day in this week
                const date = getDateForWeekDay(weekNumber, day);
                
                // Only add if date is valid (within plan range)
                if (date) {
                    // Calculate the price using the same formula (will be 0 if selectedValue is 0)
                    let calculatedPrice = 0;
                    if (selectedValue > 0 && contacts > 0) {
                        const sum = contacts * selectedValue / 30 * 2;
                        calculatedPrice = contacts * 1 * sum;
                    }
                    
                    pricingData.push({
                        hour: hour,
                        day_name: day,
                        selected_value: selectedValue,
                        calculated_price: calculatedPrice,
                        contacts: contacts,
                        date: date
                    });
                }
            }
        });
    }
    
    console.log(`About to save ${pricingData.length} pricing records for plan ${planId}, booking ${bookingIdNum}, screen ${screenId}, week ${weekNumber}`);
    console.log('Pricing data:', pricingData);
    
    if (pricingData.length > 0) {
        // Send to API
        const payload = {
            dooh_plan_id: planId,
            screen_id: screenId,
            week_number: weekNumber,
            pricing_data: pricingData
        };
        
        console.log('Sending payload:', payload);
        
        fetch('/api/media-plan-pricing/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Saved ${data.saved_count} pricing records for ${bookingId}`);
                // Refresh calendar totals immediately
                refreshCalendarTotals();
            } else {
                console.error('Failed to save pricing data:', data.message);
            }
        })
        .catch(error => {
            console.error('Error saving pricing data:', error);
        });
    }
}

// Helper function to calculate date for a given week and day
function getDateForWeekDay(weekNumber, dayName) {
    console.log(`getDateForWeekDay called: weekNumber=${weekNumber}, dayName=${dayName}`);
    
    // Use the same logic as the backend route to calculate week dates
    // Get the Monday of week 1 (start Monday)
    const startMonday = new Date(planStartDate);
    const daysToMonday = startMonday.getDay() === 0 ? 6 : startMonday.getDay() - 1; // Convert to Monday-based week
    startMonday.setDate(startMonday.getDate() - daysToMonday);
    
    console.log(`Start Monday: ${startMonday.toISOString().split('T')[0]}`);
    
    // Calculate the target week's Monday
    const weekMonday = new Date(startMonday);
    weekMonday.setDate(startMonday.getDate() + (weekNumber - 1) * 7);
    
    console.log(`Week ${weekNumber} Monday: ${weekMonday.toISOString().split('T')[0]}`);
    
    // Add days for the specific weekday
    const dayOffsets = { 'mon': 0, 'tue': 1, 'wed': 2, 'thu': 3, 'fri': 4, 'sat': 5, 'sun': 6 };
    const targetDate = new Date(weekMonday);
    targetDate.setDate(weekMonday.getDate() + dayOffsets[dayName]);
    
    console.log(`Calculated target date: ${targetDate.toISOString().split('T')[0]}`);
    
    // Check if the calculated date is within plan range
    if (targetDate >= planStartDate && targetDate <= planEndDate) {
        const result = targetDate.toISOString().split('T')[0];
        console.log(`✓ Date is within plan range: ${result}`);
        return result;
    } else {
        console.log(`✗ Date ${targetDate.toISOString().split('T')[0]} is outside plan range (${planStartDate.toISOString().split('T')[0]} to ${planEndDate.toISOString().split('T')[0]})`);
        return null; // Return null for dates outside plan range
    }
}

// Load saved pricing data and update calendar
function loadPricingData() {
    return fetch(`/api/media-plan-pricing/${planId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update calendar with daily totals
                updateCalendarTotals(data.daily_totals);
                
                // Populate form fields with saved data
                populateFormFields(data.saved_pricing);
                
                return data; // Return data for chaining
            } else {
                console.error('Failed to load pricing data:', data.message);
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Error loading pricing data:', error);
            throw error;
        });
}

// Refresh only calendar totals (without repopulating forms)
function refreshCalendarTotals() {
    fetch(`/api/media-plan-pricing/${planId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear existing calendar totals first
                clearCalendarTotals();
                
                // Update calendar with fresh daily totals
                updateCalendarTotals(data.daily_totals);
            } else {
                console.error('Failed to refresh calendar totals:', data.message);
            }
        })
        .catch(error => {
            console.error('Error refreshing calendar totals:', error);
        });
}

// Clear calendar totals before updating
function clearCalendarTotals() {
    // Reset all cost displays to 0.00€
    document.querySelectorAll('[id^="cost_"]').forEach(costElement => {
        costElement.textContent = '0.00€';
        costElement.style.fontWeight = 'normal';
        costElement.style.color = '#6b7280'; // Gray color
    });
    
    // Reset all day totals
    document.querySelectorAll('[id^="dayTotal_"]').forEach(dayTotalElement => {
        dayTotalElement.textContent = '0.00€';
    });
}

// Update calendar daily totals
function updateCalendarTotals(dailyTotals) {
    // Update the calendar cells with price totals
    Object.keys(dailyTotals).forEach(dateStr => {
        const price = dailyTotals[dateStr];
        
        // Find the corresponding calendar cell
        const dayIndex = Math.floor((new Date(dateStr) - planStartDate) / (1000 * 60 * 60 * 24));
        
        // Update day total (replace, not add, since we cleared first)
        const dayTotalElement = document.getElementById(`dayTotal_${dayIndex}`);
        if (dayTotalElement) {
            dayTotalElement.textContent = price.toFixed(2) + '€';
            dayTotalElement.style.fontWeight = 'bold';
            dayTotalElement.style.color = '#059669'; // Green color for totals with saved data
        }
        
        // Update individual screen cost displays proportionally 
        // (This is more complex - for now just show the total in each cell)
        document.querySelectorAll(`[id^="cost_"][id$="_${dayIndex}"]`).forEach(costElement => {
            costElement.textContent = price.toFixed(2) + '€';
            costElement.style.fontWeight = 'bold';
            costElement.style.color = '#059669'; // Green color
        });
    });
}

// Populate form fields with saved data
function populateFormFields(savedPricing) {
    console.log('Populating form fields with saved data:', savedPricing);
    Object.keys(savedPricing).forEach(bookingKey => {
        console.log(`Processing booking: ${bookingKey}`);
        const pricingData = savedPricing[bookingKey];
        
        Object.keys(pricingData).forEach(hourDayKey => {
            const [hour, day] = hourDayKey.split('_');
            const data = pricingData[hourDayKey];
            
            // Find the input element and set its value
            const input = document.querySelector(`input[data-booking="${bookingKey}"][data-hour="${hour}"][data-day="${day}"]`);
            if (input) {
                input.value = data.selected_value;
                
                // Update the price display
                const priceDisplay = document.getElementById(`price_${bookingKey}_${hour}_${day}`);
                if (priceDisplay) {
                    priceDisplay.textContent = data.calculated_price.toFixed(2) + '€';
                }
            }
        });
        
        // Recalculate totals for this booking (skip auto-save to prevent loop)
        // calculatePrices(bookingKey); // Skip this to prevent save loop on page load
    });
}

// Calculate prices with the formula: tkst.kontaktu * (30 or 60) / 30 * 2 = SUM, tkst.kontaktu * 1 * SUM = kaina
function calculatePrices(bookingId) {
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    let dayTotals = {};
    let totalPrice = 0;
    let totalSlots = 0;
    
    // Initialize day totals
    days.forEach(day => {
        dayTotals[day] = 0;
    });
    
    // Initialize day price totals
    let dayPriceTotals = {};
    days.forEach(day => {
        dayPriceTotals[day] = 0;
    });
    
    // Calculate prices for each hour and day for this booking
    for (let hour = 6; hour < 24; hour++) {
        // Get the price from TRP for this hour
        const priceElement = document.querySelector(`.time-row-${hour} span[data-price]`);
        const trpPrice = priceElement ? parseFloat(priceElement.dataset.price) : 0;
        
        days.forEach(day => {
            const input = document.querySelector(`input[data-booking="${bookingId}"][data-hour="${hour}"][data-day="${day}"]`);
            
            if (input) {
                const selectedValue = parseInt(input.value || 0);
                const contacts = parseFloat(input.dataset.contacts || 0); // contacts in thousands
                
                if (selectedValue > 0 && contacts > 0) {
                    // Step 1: SUM = tukst kontaktu * (60 or 30) / 30 * 2
                    const sum = contacts * selectedValue / 30 * 2;
                    
                    // Step 2: TUKST. kontaktu * 1 * SUM = kaina
                    const kaina = contacts * 1 * sum;
                    
                    // Display the calculated price
                    const priceDisplay = document.getElementById(`price_${bookingId}_${hour}_${day}`);
                    if (priceDisplay) {
                        priceDisplay.textContent = kaina.toFixed(2) + '€';
                    }
                    
                    dayTotals[day] += selectedValue;
                    dayPriceTotals[day] += kaina;
                    totalSlots += selectedValue;
                    totalPrice += kaina;
                } else {
                    // Clear price display if no value selected
                    const priceDisplay = document.getElementById(`price_${bookingId}_${hour}_${day}`);
                    if (priceDisplay) {
                        priceDisplay.textContent = '-';
                    }
                }
            }
        });
    }
    
    // Update day totals and day prices
    days.forEach(day => {
        const dayTotalElement = document.querySelector(`.day-total-${day}[data-booking="${bookingId}"]`);
        if (dayTotalElement) {
            dayTotalElement.textContent = dayTotals[day];
        }
        
        const dayPriceElement = document.querySelector(`.day-price-${day}[data-booking="${bookingId}"]`);
        if (dayPriceElement) {
            dayPriceElement.textContent = dayPriceTotals[day].toFixed(2) + '€';
        }
    });
    
    // Update total price displays
    const totalPriceElement = document.querySelector(`.total-price[data-booking="${bookingId}"]`);
    if (totalPriceElement) {
        totalPriceElement.textContent = totalPrice.toFixed(2);
    }
    
    const screenTotalPriceElement = document.querySelector(`.screen-total-price[data-booking="${bookingId}"]`);
    if (screenTotalPriceElement) {
        screenTotalPriceElement.textContent = totalPrice.toFixed(2) + '€';
    }
    
    // Update CPT calculation
    const cptElement = document.querySelector(`[data-booking="${bookingId}"].cpt-value`);
    if (cptElement) {
        const cpt = totalSlots > 0 ? (totalPrice / totalSlots) : 0;
        cptElement.textContent = cpt.toFixed(2);
    }
    
    // Recalculate overall totals
    calculateOverallTotals();
    
    // Auto-save the pricing data
    savePricingData(bookingId);
}


// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    
    // Load saved pricing data first, then initialize calculations
    loadPricingData()
        .then(() => {
            // After loading saved data, calculate totals
            calculateTotals();
            
            // Initialize all screen calculations
            document.querySelectorAll('.screen-planning-card').forEach((card, index) => {
                const bookingElement = card.querySelector('[data-booking]');
                if (bookingElement) {
                    const bookingId = bookingElement.dataset.booking;
                    console.log(`Initializing screen ${index + 1} with booking ID: ${bookingId}`);
                    calculateScreenTotals(bookingId);
                }
            });
        })
        .catch((error) => {
            // If loading saved data fails, still initialize with empty state
            console.warn('Failed to load saved data, initializing empty:', error);
            calculateTotals();
            
            // Initialize all screen calculations
            document.querySelectorAll('.screen-planning-card').forEach(card => {
                const bookingElement = card.querySelector('[data-booking]');
                if (bookingElement) {
                    const bookingId = bookingElement.dataset.booking;
                    calculateScreenTotals(bookingId);
                }
            });
        });
});
</script>

<style>
/* TV-Planning Style Calendar - Updated for Tailwind */
.calendar-day-cell {
    @apply bg-white p-4 border border-gray-200 align-middle;
    min-height: 80px;
}

.calendar-day-cell.disabled {
    @apply bg-gray-50 text-gray-500;
}

.date-number {
    @apply text-2xl font-bold text-indigo-600 mb-1;
}

.date-month {
    @apply text-xs text-gray-500 uppercase mb-2 font-semibold;
}

.cpt-value {
    @apply text-sm font-bold text-green-600 bg-gray-50 px-2 py-1 border border-gray-200 rounded inline-block;
    min-width: 60px;
}

.calendar-date:hover:not(.disabled) {
    background-color: #e3f2fd;
}

.calendar-date.selected-week {
    background-color: #007bff;
    color: white;
    font-weight: bold;
}

.calendar-date.other-month {
    color: #adb5bd;
    background-color: #f8f9fa;
}

.calendar-date.disabled {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

.selected-week-info {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.new-week-info {
    background-color: #f0f8f0;
    padding: 1rem;
    border-radius: 0.375rem;
    border: 1px solid #d4edda;
}

/* New week calendar specific styles */
.new-week-calendar-date:hover:not(.disabled) {
    background-color: #d4edda;
}

.new-week-calendar-date.selected-week {
    background-color: #28a745;
    color: white;
    font-weight: bold;
}

/* Animation for new week calendar */
#newWeekCalendarCard {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Media Planning Table Styles */
.media-planning-table {
    font-size: 0.75rem;
    margin-bottom: 0;
}

.media-planning-table th {
    background-color: #007bff;
    color: white;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #0056b3;
    padding: 0.25rem;
}

.media-planning-table td {
    padding: 0.2rem;
    vertical-align: middle;
    border: 1px solid #dee2e6;
}

.kartai-input {
    border: 1px solid #ced4da;
    padding: 2px 4px;
    font-size: 0.7rem;
    text-align: center;
    width: 100%;
    max-width: 45px;
}

.kartai-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.1rem rgba(0, 123, 255, 0.25);
}

.suma-display {
    font-size: 0.65rem;
    color: #28a745;
    font-weight: 500;
}

.screen-planning-card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Row alternating colors */
.kartai-row-1 {
    background-color: #ffffff;
}

.suma-row-1 {
    background-color: #f8f9fa !important;
}

.kartai-row-2 {
    background-color: #ffffff;
}

.suma-row-2 {
    background-color: #f8f9fa !important;
}

/* Responsive design */
@media (max-width: 768px) {
    .calendar-grid {
        font-size: 0.8rem;
    }
    
    .media-planning-table {
        font-size: 0.65rem;
    }
    
    .kartai-input {
        width: 35px;
        font-size: 0.6rem;
    }
}

/* Smooth horizontal scrolling for calendar and week containers */
.overflow-x-auto {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.overflow-x-auto::-webkit-scrollbar {
    height: 10px;
}

.overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Compact week cards */
.screen-planning-card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s;
}

.screen-planning-card:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}

/* Compact input styling */
.weekday-input::-webkit-inner-spin-button,
.weekday-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.weekday-input {
    -moz-appearance: textfield;
}

/* Fade effect for scroll hint */
@keyframes fadeInOut {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.scroll-hint {
    animation: fadeInOut 2s ease-in-out infinite;
}
</style>
{% endblock %}