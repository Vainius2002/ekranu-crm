{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Ekranų Pasirinkimas</h1>
        <p class="text-muted">{{ plan.name }} ({{ plan.start_date.strftime('%Y-%m-%d') }} - {{ plan.end_date.strftime('%Y-%m-%d') }})</p>
    </div>
    <div>
        <a href="{{ url_for('dooh_plan_media', id=plan.id) }}" class="btn btn-warning">
            <i class="fas fa-arrow-right me-2"></i>Pereiti prie Media Plano
        </a>
        <a href="{{ url_for('dooh_plan_detail', id=plan.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Grįžti
        </a>
    </div>
</div>

<!-- Selected screens summary -->
{% if plan.screen_bookings %}
<div class="alert alert-success mb-4">
    <h5><i class="fas fa-check-circle me-2"></i>Pasirinkti Ekranai ({{ plan.screen_bookings|length }})</h5>
    <div class="row">
        {% for booking in plan.screen_bookings %}
        <div class="col-md-6 col-lg-4 mb-2">
            <span class="badge bg-success me-2">{{ booking.screen.name }}</span>
            <small class="text-muted">{{ booking.screen.city }}</small>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Search and filter controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label for="searchInput" class="form-label">Paieška</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Ieškoti pagal pavadinimą, miestą...">
            </div>
            <div class="col-md-3">
                <label for="cityFilter" class="form-label">Miestas</label>
                <select id="cityFilter" class="form-select">
                    <option value="">Visi miestai</option>
                    {% set cities = [] %}
                    {% for screen in screens %}
                        {% if screen.city not in cities %}
                            {% set _ = cities.append(screen.city) %}
                        {% endif %}
                    {% endfor %}
                    {% for city in cities|sort %}
                        <option value="{{ city }}">{{ city }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="typeFilter" class="form-label">Tipas</label>
                <select id="typeFilter" class="form-select">
                    <option value="">Visi tipai</option>
                    <option value="horizontal">Horizontalus</option>
                    <option value="vertical">Vertikalus</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-outline-secondary d-block w-100" onclick="clearFilters()">
                    Valyti
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Available screens grid -->
<div class="row" id="screensGrid">
    {% for screen in screens %}
    {% set is_selected = plan.screen_bookings|selectattr('screen_id', 'equalto', screen.id)|list|length > 0 %}
    <div class="col-md-6 col-lg-4 mb-4 screen-card" 
         data-city="{{ screen.city }}" 
         data-type="{{ screen.screen_type }}"
         data-name="{{ screen.name|lower }}"
         data-address="{{ screen.address|lower }}">
        <div class="card {{ 'border-success' if is_selected else '' }}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">{{ screen.name }}</h6>
                    {% if is_selected %}
                        <span class="badge bg-success">Pasirinktas</span>
                    {% endif %}
                </div>
                
                <p class="card-text small text-muted mb-2">
                    <i class="fas fa-building me-1"></i>{{ screen.provider.name }}<br>
                    <i class="fas fa-map-marker-alt me-1"></i>{{ screen.city }}, {{ screen.address }}
                </p>
                
                <div class="mb-2">
                    <span class="badge bg-{{ 'primary' if screen.screen_type == 'horizontal' else 'secondary' }} me-1">
                        {{ 'Horizontalus' if screen.screen_type == 'horizontal' else 'Vertikalus' }}
                    </span>
                    <span class="badge bg-{{ 'success' if screen.content_type == 'video' else 'info' }}">
                        {{ 'Video' if screen.content_type == 'video' else 'Statinis' }}
                    </span>
                </div>
                
                <div class="text-muted small mb-3">
                    <i class="fas fa-expand me-1"></i>{{ screen.width }}m × {{ screen.height }}m
                    {% if screen.gps_latitude and screen.gps_longitude %}
                        <br><i class="fas fa-globe me-1"></i>GPS: {{ screen.gps_latitude }}, {{ screen.gps_longitude }}
                    {% endif %}
                </div>
                
                <div class="d-flex gap-1">
                    {% if not is_selected %}
                        <form method="POST" action="{{ url_for('add_screen_to_plan', plan_id=plan.id, screen_id=screen.id) }}" class="flex-grow-1">
                            <button type="submit" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-plus me-1"></i>Pridėti
                            </button>
                        </form>
                    {% else %}
                        <button class="btn btn-outline-success btn-sm flex-grow-1" disabled>
                            <i class="fas fa-check me-1"></i>Pridėtas
                        </button>
                    {% endif %}
                    <a href="{{ url_for('screen_detail', id=screen.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not screens %}
<div class="text-center py-5">
    <i class="fas fa-tv fa-3x text-muted mb-3"></i>
    <h3>Nėra ekranų</h3>
    <p class="text-muted">Pirmiausia pridėkite ekranų į sistemą</p>
    <a href="{{ url_for('new_screen') }}" class="btn btn-success">
        <i class="fas fa-plus me-2"></i>Pridėti Ekraną
    </a>
</div>
{% endif %}

<script>
// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const cityFilter = document.getElementById('cityFilter');
    const typeFilter = document.getElementById('typeFilter');
    const screenCards = document.querySelectorAll('.screen-card');

    function filterScreens() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCity = cityFilter.value;
        const selectedType = typeFilter.value;

        screenCards.forEach(card => {
            const name = card.dataset.name;
            const address = card.dataset.address;
            const city = card.dataset.city;
            const type = card.dataset.type;

            const matchesSearch = !searchTerm || name.includes(searchTerm) || address.includes(searchTerm);
            const matchesCity = !selectedCity || city === selectedCity;
            const matchesType = !selectedType || type === selectedType;

            if (matchesSearch && matchesCity && matchesType) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterScreens);
    cityFilter.addEventListener('change', filterScreens);
    typeFilter.addEventListener('change', filterScreens);
});

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('cityFilter').value = '';
    document.getElementById('typeFilter').value = '';
    
    document.querySelectorAll('.screen-card').forEach(card => {
        card.style.display = 'block';
    });
}
</script>

<style>
.screen-card {
    transition: transform 0.2s;
}
.screen-card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}